# Global settings applied to all applications
global:
  cluster:
    serverip: 192.168.178.101
    username: root
    cluster-name: unsereiner.net
    ip-range: 192.168.178.191-192.168.178.200

  # Common domain configuration
  domain: unsereiner.net

  # Authentication settings
  akeyless:
    path: /unsereiner.net

  # Email settings for services
  email: Jonas@Hess.pm

  # DNS provider configuration
  cloudflare:
    email: Jonas@Hess.pm

  # Certificate management
  letsencrypt:
    email: Jonas@Hess.pm

  # Authentication provider
  oauth2_proxy:
    oidc_client_id: "6e1bl5i55ao7bhhcufk85ussm"
    oidc_issuer_url: "https://cognito-idp.eu-central-1.amazonaws.com/eu-central-1_t9DQfKlSX"

  argocd:
    targetRevision: main

# All applications to be deployed by Argo CD
apps:
  argocd:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values: {}

  akeyless:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values: {}

  traefik:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values:
          generic:
            persistentVolumeClaims:
              data:
                hostPath: /mnt/nutellajunkies/apps/traefik
          loadBalancerIP: 192.168.178.191
          middlewares:
            cloudflare:
              allowedCIDRs:
                - 192.168.1.0/24
                - 192.168.178.0/24
          oauth2-proxy:
            extraArgs:
              oidc-issuer-url: "https://cognito-idp.eu-central-1.amazonaws.com/eu-central-1_t9DQfKlSX"
              cookie-domain: ".unsereiner.net"
              whitelist-domain: ".unsereiner.net"
              redirect-url: "https://auth.unsereiner.net/oauth2/callback"

  homeassistant:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values:
          externalConfig:
            repoURL: "https://github.com/JonasHess/homelab-environments.git"
            targetRevision: "main"
            path: "unsereiner.net/homeassistant-config"
            configMapName: "homeassistant-app-config"
          generic:
            deployment:
              pvcMounts:
                config:
                  hostPath: /mnt/nutellajunkies/apps/homeassistant/config
              initContainers:
                - name: install-hacs
                  image: alpine:3.19
                  command:
                    - sh
                    - -c
                    - |
                      if [ -d /config/custom_components/hacs ]; then
                        echo "HACS already installed, skipping"
                      else
                        apk add --no-cache unzip
                        mkdir -p /config/custom_components
                        wget -O /tmp/hacs.zip "https://github.com/hacs/integration/releases/latest/download/hacs.zip"
                        unzip -o /tmp/hacs.zip -d /config/custom_components/hacs
                        rm /tmp/hacs.zip
                        echo "HACS installed successfully"
                      fi
                  volumeMounts:
                    - name: homeassistant-config-volume
                      mountPath: /config
                - name: copy-config
                  image: busybox:1.36
                  command:
                    - sh
                    - -c
                    - |
                      echo "Copying config files from ConfigMap to /config..."
                      cp /configmap/*.yaml /config/
                      echo "Config files copied successfully"
                  volumeMounts:
                    - name: homeassistant-config-volume
                      mountPath: /config
                    - name: homeassistant-configmap-volume
                      mountPath: /configmap
              configMapMounts:
                configmap:
                  mountPath: /configmap
                  configMapName: homeassistant-app-config

  homer:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values: {}

  reloader:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values: {}

  restic:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values:
          generic:
            persistentVolumeClaims:
              nutellajunkies:
                hostPath: /mnt/nutellajunkies
              restoreddata:
                hostPath: /mnt/nutellajunkies/apps/restic/restored-data
          cronjob:
            pvcMounts:
              nutellajunkies:
                mountPath: /mnt/nutellajunkies

  backrest:
    enabled: true
    argocd:
      targetRevision: ~
      helm:
        values:
          generic:
            persistentVolumeClaims:
              data:
                hostPath: /mnt/nutellajunkies/apps/backrest/data
              cache:
                hostPath: /mnt/nutellajunkies/apps/backrest/cache
              tmp:
                hostPath: /mnt/nutellajunkies/apps/backrest/tmp
              restore:
                hostPath: /mnt/nutellajunkies/apps/backrest/restore
